## MySQL 基准测试

1. 简单地说，基准测试是针对系统设计的一种压力测试。通常的目标是为了掌握系统的行为。但也有其他原因，如重现某个系统的状态，或者是做新硬件的可靠性测试。

2. 基准测试是唯一方便有效的、可以学习系统在给定的工作负载下会发生什么的方法。基准测试可以观察系统在不同压力下的行为，评估系统的容量，掌握那些是重要的变化，或者观察系统如何处理不同的数据。可以在负载之外创造一些虚构的场景进行测试：

   1. 验证基于系统的一些假设，确认这些假设是否符合实际情况。
   2. 重现系统中的某些异常行为，以解决这些异常。
   3. 测试系统当前的运行情况。
   4. 模拟比当前系统更高的负载，以找出系统随着压力增加而可能遇到的扩展性瓶颈。
   5. 规划未来的业务增长。基准测试可以评估在项目未来的负载下，需要什么样的硬件，需要多大容量的网络，以及其他相关的资源。
   6. 测试应用适应可变环境的能力。
   7. 测试不同的硬件、软件和操作系统配置。
   8. 正面新采购的设备是否配置正确。

3. 基准测试通常要求尽可能快的执行完成，所以经常给系统造成过大的压力。测试工具自身的局限也会影响到结果的有效性。

4. 基准测试要尽量简单直接，结果之间容易相互比较，成本低且易于执行。

5. 基准测试有两种主要的策略：

   1. 针对整个系统的整体测试，也被称为集成式。
   2. 单独测试MySQl，也被称为单组件式。

6. 针对整个系统做集成测试，而不是单独测试MySQL的原因主要有以下几点：

   1. 测试整个应用系统，包括Web服务器、应用代码、网络和数据库是非常有用的，因为用户关注的不仅仅是MySQL本身的性能，而是应用整体的性能。
   2. MySQL并非总是应用的瓶颈，通过整体的测试可以揭示这一点。
   3. 只有对应用做整体的测试，才能发现各部分之间的缓存带来的影响。
   4. 整体应用的集成式更能揭示应用的真实表现，而单独的组件测试很难做到这一点。

7. 应用的整体基准测试很难建立，甚至很难正确设置。如果基准测试的设计有问题，那么结果就无法反映真实情况，从而基于此做的决策也就可能是错误的。

8. 基于以下情况，可以选择只测试MySQL：

   1. 需要比较不同的schema或查询的性能。
   2. 针对应用中某个具体的问题的测试。
   3. 为了避免漫长的基准测试，可以通过一个短期的基准测试，做快速的“周期循环”，来解除出某些调整后的效果。

9. 如果能够在真实的数据集执行重复的查询，那么针对MySQL的基准测试也是有用的，但是数据本身和数据集的大小都应该是真实的。

10. 在开始执行甚至在设计基准测试之前，需要明确测试的目标。用不同的方法测试不同的指标。

11. 吞吐量指的是单位时间内的事务处理数，经典的数据库应用测试指标。测试单位时每秒事务数（TPS），有些也采用每分钟的事务数。

12. 响应时间或者延迟，这个指标用于测试任务所需的整体时间。根据具体的应用，测试的时间单位可能是微秒、毫秒、秒或者分钟。通常可以用百分比响应时间来替代最大响应时间。例如，如果95%的响应时间都是5毫秒，则表示任务在95%的时间段内都可以在5毫秒之内完成。

13. 并发性是一个非常重要又经常被误解和误用的指标。经常使用的指标是有多少个会话。Web服务器的并发性更准确的度量指标是在任意时间有多少同时发生的并发请求。并发性基准测试需要关注的是正在工作中的并发操作，或者是同时工作的线程数。

14. 可扩展性指的是给系统增加一倍多工作，在理想情况下就能获得两杯的结果（即吞吐量增加一倍）。或者说，给系统增加一倍的资源就可以获得两倍的吞吐量。

15. 避免一些常见的错误：

    1. 使用真实数据的子集而不是全集。
    2. 使用错误的数据分布。
    3. 使用不真实的分布参数。
    4. 在多用户场景中，只做单用户的测试。
    5. 在单服务器上测试分布式应用。
    6. 与真实用户行为不匹配。
    7. 反复执行同一个查询。
    8. 没有检查错误。基准测试完成以后，一定要检查一下错误日志，这应当是基本的要求。
    9. 忽略了系统预热的过程。
    10. 使用默认的服务器配置。
    11. 测试时间太短。

    总之，应努力使测试过程尽可能地接近真实应用环境。

16. 规划基准测试的第一步是提出问题并明确目标。然后决定是采用标准的基准测试，还是采用专用的测试。

17. 如果采用标准的基准测试，应该确认选择了合适的方案，补：TPC-H时即席查询和决策支持型应用的基准测试。

18. 设计专业的基准测试·是很复杂的，往往需要一个迭代的过程。

19. 然后针对数据运行查询，可以建立一个单元测试集作为初步的测试，并运行很多遍。更好的办法是选择一个有代表性的时间段。

20. 可以在不同级别记录查询。

21. 即使不需要创建专用的基准测试，详细地写下测试规划也是必需的。测试规划应该记录测试数据、系统配置的步骤、如何测量和分析结果，以及预热的方案等。

22. 应该建立将参数和结果文档化的规范，每一轮测试都必须进行详细记录。

23. 基准测试应该运行足够长的时间，这一点很重要。

24. 一个常见的错误的测试方式是，只执行一系列短期的测试，比如每次60S，并在此测试的基础上去总结系统的性能。

25. 在执行基准测试时，需要尽可能多地手机被测试系统的信息。最好为基准测试建立一个目录，并且每执行一轮测试都创建单独的子目录，将测试结果、配置文件、测试指标、脚本和其他相关说明都保存在其中。即使有些结果不是目前需要的，也应该先保存下来。需要记录的数据包括系统状态和性能指标，诸如CPU的使用率、磁盘I/O、网络流量统计、SHOW GLOBAL STATUS计数器等。

26. 获得准确测试结果的最好办法，就是回答关于基准测试的基本问题。

27. 接着，确认测试结果是否可重复。要注意很多因素，包括外部的压力、性能分析和监控系统、详细的日志记录、周期性作业，以及一些其他因素，都会影响到测试结果。

28. 每次测试中，修改的参数应尽量少。一般情况下，都是通过迭代逐步地修改基准测试的参数。MySQL的默认配置是基于消耗很少内存的极小应用的。

29. 如果测试中出现异常结果，不要轻易当作坏数据点而丢弃。

30. 通常来说，自动化测试是个好主意。这样做可以获得更精确的测试结果。因为自动化的过程可以防止测试人员偶尔遗漏某些重要步骤，或者误操作。

31. 自动化的方式有很多，可以是一个Makefile文件或者一组脚本。要尽可能地使所有测试过程都自动化，包括装载数据、系统预热、执行测试、记录结果等。

32. 基准测试通常需要运行很多次。具体需要运行多少次需要看对结果的记分方式，以及测试对重要程度。

33. 获得测试结果后，还需要对结果进行分析，最终的目的是回答在设计测试时的问题。

34. 最简单有效的图形，就是将性能指标按照时间顺序绘制。通过图形可以立即发现一些问题，而这些问题在原始数据中却很难注意到。

35. ab是一个Apache HTTP服务器基准测试工具。它可以测试HTTP服务器每秒最多可以处理多少请求。如果测试的是Web应用服务，这个结果可以转换为整个应用每秒可以满足多少请求。

36. http_load概念上和ab类似，也被设计为对Web服务器进行测试，但比ab要更加灵活。可以通过一个输入文件提供多个URL，http_load在这些URL中随机选择进行测试。也可以定制http_load，使其按照时间比率进行测试。

37. JMeter是一个Java程序，可以加载其他应用并测试其性能。虽然是设计用来测试Web应用的，但也可以用于测试其他诸如FTP服务器，或者通过JDBC进行数据库查询的测试。

38. mysqlslap可以模拟服务器的负载，并输出计时信息。包含在MySQL5.1的发行包中。测试时可以执行并发连接数，并指定SQL语句（可以在命令行上执行，也可以把SQL语句写入到参数文件中）。如果没有指定SQL语句，mysqlslap会自动生成查询schema的SELETE语句。

39. MySQL Benchmark Suite：MySQL发行包中提供的一款自己的基准测试套件，可以用于在不同数据库服务器上进行比较测试。它是单线程的，主要用于测试服务器执行查询的速度。结果会显示那种类型的操作在服务器上执行更快。，包含了大量预定义的测试。这些测试大部分是CPU密集型的。最大的缺点：单用户模式。

40. Super Smack是一款用于MySQL和PostgreSQL的基准测试工具，可以提供压力测试和负载生成。这是一个复杂而强大的工具，可以模拟多用户的访问，可以加载测试数据到数据库，并支持使用随机数据填充测试表。测试定义在“smack”文件中，smack文件使用一种简单的语法定义测试的客户端、表、查询等测试要素。

41. Database Test Suite是一款类似某些工业标准测试等测试工具集。

42. sysbench是一款多线程系统压测工具。他可以根据影响数据库服务器性能等各种因素来评估系统等性能。全能测试工具，支持MySQL、操作系统和硬件的硬件测试。

43. MySQL有一个内置的BENCHMARK()函数，可以测试某些特定操作的执行速度。表达式必需包含用户定义的变量，否则多次执行同样的表达式会因为系统的缓存命中而影响测试结果/