## 服务器性能剖析

1. 性能：为完成某件任务所需要的时间都度量，换句话说，性能即响应时间。数据库服务器的性能用查询的响应时间来度量，单位时每个查询花费的时间。
2. 无法度量九无法有效的优化。
3. 合适的测量范围是说只测量需要优化的活动，有两种比较常见的情况会导致不合适的测量：
   1. 在错误的时间启动和停止测量。
   2. 测量的是聚合后的信息，而不是目标活动本身。
4. 性能剖析一般有两个步骤：测量任务所花费的时间，然后对结果进行统计和排序，将重要的任务排到前面。
5. 两种类型的性能剖析：基于执行时间的分析和基于等待的分析。基于执行时间的分析研究的是什么任务执行时间最长，二基于等待的分析则是判断任务在什么地方被阻塞的时间最长。
6. 值得优化的查询：
   1. 一些只占总响应时间比重很小的查询是不值得优化的。
   2. 如果话费了1000美元去优化一个任务，但任务的收入没有任何增加，那么可以说反而导致业务被逆优化来1000美元。如果优化的成本大于收益，就应当停止优化。
7. 丢失的时间指的是任务的总响应时间和实际测量到的时间的差值。
8. 对系统进行性能剖析建议自上而下地进行，这样可以追踪自用户发起到服务器响应到整个流程。性能瓶颈可能有很多影响因素：外部资源、应用需要处理大量的数据、在循环中执行昂贵的操作和使用了低效的算法等。
9. 慢查询可以通过设置long_query_time来配置，是开销最低、精度最高的测量查询时间的工具。
10. 通用日志在查询请求到服务器时进行记录，所以不包含响应时间和执行计划等重要信息。MySQL5.1之后支持将日志记录到数据库到表中，但多数情况下这样做没什么必要。这不但对我性能有较大的影响，而去MySQL5.1在将慢查询记录到文件中时已经支持微秒级别的信息，然而将慢查询记录到表中会导致时间力度退化为只能支持到秒级
11. 方差均值比也就是常说的离差指数。离差指数高的查询对应的执行时间的变化较大，而这类查询通常都值得去优化。
12. SHOW PROFILE默认是禁用的，但可以通过服务器变量在会话（连接）级别动态地修改：SET profiling = 1.在服务器上执行的所有语句，都会测量其耗费的时间和其他一些查询执行状态变更相关的数据。
13. MuSQl的SHOW STATUS命令反悔了一些计数器。既有服务器级别的全局计数器，也有基于某个连接的会话级别的计数器。如果执行SHOW GLOBAL STATUS，则可以查看服务器级别的从服务器启动开始计算的查询次数统计。
14. 执行FLUSH STATUS将计数器重置为0.
15. 通过EXPLAIN查看查询的执行计划也可以获得大部分相同的信息，但EXPLAIN时通过估计得到的结果，而通过计数器则是实际的测量结果。
16. 当出现问题时，首要确认是单条查询的问题，还是服务器的问题。
17. SHOW PROCESSLIST可以查看MySQL执行查询的各种线程的状态。在尾部加上\G可以垂直的方式输出结果。大量线程处于“freeing items”状态是出现了大量有问题查询的明显特征和指示。
18. 查询是在完成阶段才写入慢查询日志的。
19. 对于触发器来说，选择一个合适的阈值很重要，既要足够高，以确保在正常时不会被触发；又不能太高，要确保问题发生时不会错过。另外要注意，要在问题开始时就捕获数据，就更不能将阈值设置得太高。